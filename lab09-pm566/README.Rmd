---
title: "Lab 9 - HPC"
author: "Xiaoyu Zhu"
date: "10/29/2021"
output:
  github_document:
  html_document:
    html_preview: false
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Learning goals
###In this lab, you are expected to learn/put in practice the following skills:

### Evaluate whether a problem can be parallelized or not.
### Practice with the parallel package.
### Use Rscript to submit jobs
### Practice your skills with Git.

## Problem 1: Think
### Give yourself a few minutes to think about what you just learned. List three examples of problems that you believe may be solved using parallel computing, and check for packages on the HPC CRAN task view that may be related to it.

## Problem 2: Before you
### The following functions can be written to be more efficient without using parallel:
## This function generates a n x k dataset with all its entries distributed poission with mean lambda.
```{r}
fun1 <- function(n = 100, k = 4, lambda = 4) {
  x <- NULL
  for (i in 1:n)
    x <- rbind(x, rpois(k, lambda))
  return(x)
}

fun1alt <- function(n = 100, k = 4, lambda = 4) {
  # YOUR CODE HERE
}

fun1(5,10)
ans<-fun1(5000,10)

fun1alt <- function(n = 100, k = 4, lambda = 4) {
  matrix(rpois(n * k, lambda = lambda), ncol = k)
}


# Benchmarking
microbenchmark::microbenchmark(
  fun1(),
  fun1alt()
)
```
## Find the column max (hint: Checkout the function max.col()).

```{r}
# Data Generating Process (10 x 10,000 matrix)
set.seed(1234)
x <- matrix(rnorm(1e4), nrow=10)
# Find each column's max value
fun2 <- function(x) {
  apply(x, 2, max) # actually a for loop
}
fun2alt <- function(x) {
  # position of the max value per row of x.
  idx<-max.col(t(x))
  # Do something to get the actual max value
  # x[cbind(1,15)]~x[1,15]
  # want to access x[1,16], x[4,1]
  # x[rbind(c(1,16),c(4,1))]
  x[cbind(idx, 1:ncol(x))]
}

# Benchmarking
ans_benchmark <- microbenchmark::microbenchmark(
  fun2(x),
  fun2alt(x), unit = "relative"
)
plot(ans_benchmark)
```




